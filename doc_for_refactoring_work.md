# 项目：精简 RWKV 模型训练与验证框架 (SOP for AI Agent)

**项目代号：** rwkv-peft-simple

**核心理念：**
本 SOP 的目标不是对原始 RWKV 训练框架进行表层注释或逐行翻译，而是通过注释驱动的结构重构与设计精炼，**以最简洁的代码逻辑与清晰的模块封装重建功能等价的训练框架**。最终产出必须在功能、行为、接口、训练误差表现上与原始代码保持一致，并通过自动化测试与误差比对完全验证。

**施工AI：** Athena (一个具备规划、代码生成、测试驱动开发、调试和自我修正能力的高级AI程序员)
---

## **工作流程总览**

AI Agent 将遵循“注释-理解-总结-重构”四阶段流程，确保每一步产出都是有价值的语义结构，并为下一阶段建立坚实基础。

* **阶段一：源代码理解与语义注释 (Annotate & Explain)**
* **阶段二：模块结构总结与文档生成 (Summarize & Document)**
* **阶段三：架构问题识别与重构提案 (Diagnose & Refactor Plan)**
* **阶段四：功能等价重构与验证提交 (Rebuild & Verify)**

---

## **阶段一：源代码理解与语义注释 (Annotate & Explain)**

**目标：** 对指定目录下的所有 Python 文件，添加全面、结构化、具备功能视角的注释，包括模块级、类级、函数级信息。

* **步骤 1.1: 文件级注释**

  * **任务：** 在每个 Python 文件的最开头添加文件头注释，说明：

    * 该文件在整个项目架构中所扮演的详细功能角色
    * 是否是独立使用模块、核心逻辑中间层，或是工具依赖
    * 核心逻辑依赖的其他模块（精确到函数级, 传参并不包含在内）

* **步骤 1.2: 类与函数注释**

  * **任务：** 为每个类与函数添加注释，覆盖以下要素：

    * **功能说明：** 该类/函数在业务流程中的角色
    * **关键逻辑：** 简要列出内部处理步骤（如“初始化模型 -> 构建优化器 -> 注册callback”）
    * **输入参数说明：** 尤其标明 config 超参数的字段（例如 config.train.batch\_size），并给出典型值或可选范围
    * **返回值说明**
    * **副作用说明（若有）：** 如写文件、修改全局状态、变更模型状态等

---

## **阶段二：模块结构总结与文档生成 (Summarize & Document)**

**目标：** 在每个目录中生成自动化的 Markdown 文档，总结该目录下的模块职责、结构逻辑，并建立自下而上的结构认知。

* **步骤 2.1: 单层目录结构文档**

  * **任务：** 在每个源码目录中生成一个 `MODULE_SUMMARY.md`，内容包括：

    * 该目录的功能定位（如“训练逻辑层”、“模型构造层”、“配置解析层”）
    * 所有 `.py` 文件的职责与交互关系图（可用层级列表或 Mermaid）
    * 模块之间的调用/依赖方向
    * 该目录向上暴露的公共接口（如 `train()`、`load_model()`）

* **步骤 2.2: 项目总览文档**

  * **任务：** 自动生成项目根目录下的 `README.md`，内容包括：

    * 项目介绍
    * 核心功能模块概览
    * 训练流程图（可用 Mermaid）
    * 如何运行训练、验证、评估
    * 可调参数说明与推荐配置（读取自config类注释）
    * 当前模块之间的封装层级图

---

## **阶段三：架构问题识别与重构提案 (Diagnose & Refactor Plan)**

**目标：** 分析项目现有结构中的冗余、过度封装、传参链混乱、抽象层级错位等问题，并提出结构性精简方案。

* **步骤 3.1: 冗余识别**

  * **任务：** 枚举如下设计问题并定位对应文件与函数：

    * 明显的工具函数重复（如重复定义的日志打印）
    * config 参数传递链过长且无定向依赖
    * 某些 wrapper 层没有提供语义封装，仅增加间接性
    * 类之间耦合度过高，或接口职责模糊

* **步骤 3.2: 精简重构提案**

  * **任务：** 输出 `REFACTOR_PLAN.md` 文件，包括以下内容：

    * 识别到的问题列表及其影响范围
    * 重构目标（如“合并 xxx 和 yyy 两个训练入口逻辑”、“消除config.deep\_nested冗余传参链”）
    * **验收标准：**

      * 所有单元测试和集成测试通过
      * 训练输出误差值与原始版本严格一致（误差绝对值 < 1e-7）
      * 模块数不增加，文件数量不增加，行数明显下降
      * 结构更清晰，职责边界更清楚

---

## **阶段四：功能等价重构与验证提交 (Rebuild & Verify)**

**目标：** 在不影响训练/验证/评估结果的前提下，对整个框架进行精简重构，验证等价性并创建 PR。

* **步骤 4.1: 重构副本创建**

  * **任务：** 在原始 `.py` 文件旁创建 `xxx.refactor.py` 副本，逐步替代原始逻辑
  * **要求：**

    * 每次重构保留全部测试通路
    * 保留原始命名与结构以便 diff 比较

* **步骤 4.2: 验证与比对**

  * **任务：** 对比原始与重构后的训练过程：

    * 对同一 config 与种子运行，记录 loss 曲线
    * 对输出 logits 进行逐步 diff（误差容忍绝对值 < 1e-7）

* **步骤 4.3: 自动测试与清理**

  * **任务：**

    * 运行全套 pytest/vitest 测试
    * 重建后的模块替换原始版本
    * 删除所有 `.rebuild.py` 文件，保留 `git diff` 信息

* **步骤 4.4: 提交与说明**

  * **任务：**

    * 创建 commit 或 PR，并附带说明文档 `CHANGES.md`，列出：

      * 所有重构点
      * 重构前后误差值对比表
      * 模块复杂度对比（文件数、平均函数长度、平均调用深度）
    * 确保 CI/CD 或构建流程通过

---

### 附录：Agent 限定能力（Athena-Simple 的控制边界）

* Athena 不会在已有工作区之外新建目录结构。
* Athena 不会重写用户已有训练入口逻辑，除非其完全冗余。
* Athena 的重构必须满足功能等价 + 误差为零。
* 若模块连续5次无法重构通过测试，将标记为 `NEEDS_MANUAL_REVIEW`，跳过当前阶段。

### 项目使用uv激活环境, 记得调取source .venv/bin/activate